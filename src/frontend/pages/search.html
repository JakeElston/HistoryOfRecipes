<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Recipes</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand text-white ms-3" href="homepage.html">Recipe History</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon" style="color: white;"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-3">
          <li class="nav-item"><a class="nav-link" href="homepage.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="search.html">Search</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="sources.html">Sources</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact Us</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <h1 class="main-title">Search Recipes</h1>

    <!-- Category Dropdown -->
    <div class="row justify-content-center mb-3">
      <div class="col-md-6">
        <select id="categorySelect" class="form-select">
          <option value="">All Categories</option>
          <option value="Amish/Pennsylvania Dutch">Amish/Pennsylvania Dutch</option>
          <option value="Latin American">Latin American</option>
          <option value="French">French</option>
          <option value="German">German</option>
          <option value="Eastern European/Russian">Eastern European/Russian</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="Greek">Greek</option>
          <option value="Jewish">Jewish</option>
          <option value="Italian">Italian</option>
          <option value="Middle Eastern/N. African">Middle Eastern/N. African</option>
          <option value="Asian">Asian</option>
          <option value="U.S./Southern">U.S./Southern</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>

    <!-- Search Input -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-6 position-relative">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="searchInput" class="form-control search-input" placeholder="Search recipes...">
      </div>
    </div>

    <!-- Recipe Cards -->
    <div class="row" id="recipeContainer">
      <div class="col-12 text-center">
        <p class="text-muted">Loading recipes...</p>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    let allRecipes = [];
    let currentCategory = '';

    // Fetch recipes from backend (with optional category filter)
    async function fetchRecipes(category = '') {
      try {
        const url = category 
          ? `http://localhost:5000/essays?category=${encodeURIComponent(category)}`
          : 'http://localhost:5000/essays';
        
        console.log('Fetching from:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Recipes fetched:', data.length);
        
        allRecipes = data;
        displayRecipes(allRecipes);
      } catch (error) {
        console.error('Error fetching recipes:', error);
        document.getElementById('recipeContainer').innerHTML = 
          '<div class="col-12"><p class="text-center text-muted">Error loading recipes. Make sure backend is running on http://localhost:5000</p></div>';
      }
    }

    // Display recipes
    function displayRecipes(recipes) {
      const container = document.getElementById('recipeContainer');
      
      if (recipes.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No recipes found.</p></div>';
        return;
      }

      console.log('First recipe author:', recipes[0]?.author); // Debug log

      container.innerHTML = recipes.map(recipe => `
        <div class="col-md-4 mb-4">
          <div class="recipe-card h-100" onclick="viewRecipe('${recipe._id}')">
            <div class="recipe-card-body d-flex flex-column" style="height: 100%;">
              <h5 class="recipe-title">${recipe.name || 'Untitled'}</h5>
              <p class="recipe-author">by ${recipe.author || 'Unknown'}</p>
              <p class="text-muted flex-grow-1" style="overflow: hidden; text-overflow: ellipsis;">${recipe.essay ? recipe.essay.substring(0, 100) + '...' : ''}</p>
              ${recipe.tags ? `<span class="recipe-tag mt-auto">${recipe.tags}</span>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // Filter recipes by search term (client-side)
    function filterBySearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      if (!searchTerm) {
        displayRecipes(allRecipes);
        return;
      }

      const filtered = allRecipes.filter(recipe =>
        (recipe.name && recipe.name.toLowerCase().includes(searchTerm)) ||
        (recipe.author && recipe.author.toLowerCase().includes(searchTerm)) ||
        (recipe.essay && recipe.essay.toLowerCase().includes(searchTerm))
      );

      displayRecipes(filtered);
    }

    // Handle category change (fetches from MongoDB)
    function handleCategoryChange() {
      const selectedCategory = document.getElementById('categorySelect').value;
      currentCategory = selectedCategory;
      
      // Clear search input when changing category
      document.getElementById('searchInput').value = '';
      
      // Fetch recipes for selected category from MongoDB
      fetchRecipes(selectedCategory);
    }

    // View recipe details
    function viewRecipe(id) {
      window.location.href = `recipe.html?id=${id}`;
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterBySearch);
    document.getElementById('categorySelect').addEventListener('change', handleCategoryChange);

    // Load all recipes on page load
    fetchRecipes();
  </script>
</body>
</html>
